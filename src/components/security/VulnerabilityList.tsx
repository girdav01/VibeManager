"use client";

import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { SeverityLevel, VulnerabilityType } from "@prisma/client";
import { CheckCircle2, AlertTriangle, XCircle, Info } from "lucide-react";

interface Vulnerability {
  id: string;
  type: VulnerabilityType;
  severity: SeverityLevel;
  title: string;
  description: string;
  filePath?: string | null;
  lineNumber?: number | null;
  cveId?: string | null;
  cvssScore?: number | null;
  packageName?: string | null;
  packageVersion?: string | null;
  fixedVersion?: string | null;
  resolved: boolean;
}

interface VulnerabilityListProps {
  vulnerabilities: Vulnerability[];
  onResolve?: (id: string, resolved: boolean) => void;
}

export function VulnerabilityList({ vulnerabilities, onResolve }: VulnerabilityListProps) {
  const getSeverityBadge = (severity: SeverityLevel) => {
    const variants: Record<SeverityLevel, { variant: any; icon: any }> = {
      CRITICAL: { variant: "destructive", icon: XCircle },
      HIGH: { variant: "destructive", icon: AlertTriangle },
      MEDIUM: { variant: "default", icon: AlertTriangle },
      LOW: { variant: "secondary", icon: Info },
      INFO: { variant: "outline", icon: Info },
    };

    const config = variants[severity];
    const Icon = config.icon;

    return (
      <Badge variant={config.variant} className="flex items-center gap-1">
        <Icon className="h-3 w-3" />
        {severity}
      </Badge>
    );
  };

  const getTypeLabel = (type: VulnerabilityType) => {
    return type.replace(/_/g, " ");
  };

  if (vulnerabilities.length === 0) {
    return (
      <Card>
        <CardContent className="text-center py-12">
          <CheckCircle2 className="h-12 w-12 text-green-500 mx-auto mb-4" />
          <p className="text-lg font-medium">No vulnerabilities found!</p>
          <p className="text-sm text-muted-foreground mt-2">
            Your code is looking secure.
          </p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-4">
      {vulnerabilities.map((vuln) => (
        <Card key={vuln.id} className={vuln.resolved ? "opacity-60" : ""}>
          <CardHeader>
            <div className="flex items-start justify-between">
              <div className="space-y-1 flex-1">
                <div className="flex items-center gap-2">
                  {getSeverityBadge(vuln.severity)}
                  <Badge variant="outline">{getTypeLabel(vuln.type)}</Badge>
                  {vuln.cveId && (
                    <Badge variant="outline">
                      <a
                        href={`https://nvd.nist.gov/vuln/detail/${vuln.cveId}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="hover:underline"
                      >
                        {vuln.cveId}
                      </a>
                    </Badge>
                  )}
                  {vuln.resolved && (
                    <Badge variant="outline" className="bg-green-50">
                      <CheckCircle2 className="h-3 w-3 mr-1" />
                      Resolved
                    </Badge>
                  )}
                </div>
                <CardTitle className="text-lg">{vuln.title}</CardTitle>
                <CardDescription>{vuln.description}</CardDescription>
              </div>
              {onResolve && (
                <Button
                  variant={vuln.resolved ? "outline" : "default"}
                  size="sm"
                  onClick={() => onResolve(vuln.id, !vuln.resolved)}
                >
                  {vuln.resolved ? "Mark Unresolved" : "Mark Resolved"}
                </Button>
              )}
            </div>
          </CardHeader>
          <CardContent>
            <div className="grid gap-2 text-sm">
              {vuln.packageName && (
                <div className="flex items-center gap-2">
                  <span className="font-medium">Package:</span>
                  <code className="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">
                    {vuln.packageName}@{vuln.packageVersion}
                  </code>
                  {vuln.fixedVersion && (
                    <>
                      <span className="text-muted-foreground">â†’</span>
                      <code className="bg-green-100 dark:bg-green-900 px-2 py-1 rounded text-green-700 dark:text-green-300">
                        {vuln.fixedVersion}
                      </code>
                    </>
                  )}
                </div>
              )}
              {vuln.filePath && (
                <div className="flex items-center gap-2">
                  <span className="font-medium">Location:</span>
                  <code className="bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">
                    {vuln.filePath}
                    {vuln.lineNumber && `:${vuln.lineNumber}`}
                  </code>
                </div>
              )}
              {vuln.cvssScore !== null && vuln.cvssScore !== undefined && (
                <div className="flex items-center gap-2">
                  <span className="font-medium">CVSS Score:</span>
                  <Badge variant="outline">{vuln.cvssScore.toFixed(1)}/10</Badge>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
